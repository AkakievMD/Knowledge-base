---
- name: install
  hosts: hostname
  become: yes

  tasks:
  - blockinfile:
     path: /etc/yum.repos.d/elastic.repo
     create: yes
     block: |
      [elasticsearch]
      name=Elasticsearch repository for 7.x packages
      baseurl=https://artifacts.elastic.co/packages/7.x/yum
      gpgcheck=1
      gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
      enabled=1
      autorefresh=1
      type=rpm-md

  - yum:
     name: "{{item}}"
     state: latest
    loop:
     - java
     - nginx
     - httpd-tools 
     - elasticsearch
     - kibana

  - lineinfile:
      path: /etc/elasticsearch/elasticsearch.yml
      regexp: '^#cluster.name: my-application'
      line: 'cluster.name: hostname'
      firstmatch: yes

  - lineinfile:
      path: /etc/elasticsearch/elasticsearch.yml
      regexp: '^#node.name: node-1'
      line: 'node.name: hostname'
      firstmatch: yes

  - lineinfile:
      path: /etc/elasticsearch/elasticsearch.yml
      regexp: '^#network.host: 192.168.0.1'
      line: 'network.host: localhost'
      firstmatch: yes

  - lineinfile:
      path: /etc/elasticsearch/elasticsearch.yml
      regexp: '^#http.port: 9200'
      line: 'http.port: 9200'
      firstmatch: yes

  - lineinfile:
      path: /etc/elasticsearch/elasticsearch.yml
      insertafter: '^# Bootstrap the cluster using an initial set of master-eligible nodes:'
      line: 'discovery.seed_hosts: ["ip-address"]'
      firstmatch: yes

  - lineinfile:
      path: /etc/elasticsearch/elasticsearch.yml
      insertafter: '^# For more information, consult the discovery and cluster formation module documentation.'
      line: 'cluster.initial_master_nodes: ["hostname"]'
      firstmatch: yes

  - lineinfile:
      path: /etc/sysconfig/elasticsearch
      regexp: '^#MAX_LOCKED_MEMORY=unlimited'
      line: 'MAX_LOCKED_MEMORY=unlimited'
      firstmatch: yes

  - lineinfile:
      path: /etc/elasticsearch/elasticsearch.yml
      regexp: '^#bootstrap.memory_lock: true'
      line: 'bootstrap.memory_lock: true'
      firstmatch: yes

  - lineinfile:
      path: /usr/lib/systemd/system/elasticsearch.service
      insertafter: '^PrivateTmp=true'
      line: 'LimitMEMLOCK=infinity'
      firstmatch: yes

  - lineinfile:
      path: /etc/kibana/kibana.yml
      regexp: '^#server.port: 5601'
      line: 'server.port: 5601'
      firstmatch: yes

  - lineinfile:
      path: /etc/kibana/kibana.yml
      regexp: '^#server.host: \"localhost\"'
      line: 'server.host: "localhost"'
      firstmatch: yes

  - lineinfile:
      path: /etc/kibana/kibana.yml
      regexp: '^#server.name: \"your-hostname\"'
      line: 'server.name: "angeloT1"'
      firstmatch: yes

  - lineinfile:
      path: /etc/kibana/kibana.yml
      insertafter: '^# The URLs of the Elasticsearch instances to use for all your queries.'
      line: 'elasticsearch.host: ["http://localhost:9200"]'
      firstmatch: yes
       
  - firewalld:
      port: 9200/tcp
      permanent: yes
      immediate: yes
      state: enabled

  - firewalld:
      port: 5601/tcp
      permanent: yes
      immediate: yes
      state: enabled

  - name: start
    systemd:
      daemon_reload: yes
      state: started
      name: "{{item}}"
      enabled: yes
    loop:
      - elasticsearch
      - kibana
      - nginx